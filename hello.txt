import React, { useState, useRef } from 'react';
import { Alert, Text, TouchableOpacity, View, Image, SafeAreaView } from 'react-native';
import { Ionicons } from '@expo/vector-icons';
import { Camera } from 'expo-camera';  // Assuming you're using expo-camera

export default function TimeInScreen() {
    const [showCamera, setShowCamera] = useState<boolean>(false);  // State to show or hide the camera
    const [picture, setPicture] = useState<string | null>(null);    // State to store the captured picture
    const cameraRef = useRef<any>(null);  // Create a ref for the camera

    const handleTakePicture = (): void => {
        Alert.alert(
            'Take Picture',
            'This feature will open the camera to take a photo for verification.',
            [
                { text: 'Cancel', style: 'cancel' },
                {
                    text: 'Open Camera',
                    onPress: () => setShowCamera(true),
                },
            ]
        );
    };

    // Capture the picture using the camera ref
    const handleCapture = async () => {
        if (cameraRef.current) {
            const options = {
                quality: 1,  // High quality
                base64: true,  // Get base64 string of the photo
                exif: false,  // Don't include EXIF data
            };

            // Capture photo and store in the state
            const photo = await cameraRef.current.takePictureAsync(options);
            setPicture(photo.base64);  // Set the captured photo's base64 string to the state
            setShowCamera(false);  // Close camera after taking the picture
        }
    };

    // Display the captured picture
    const renderPicture = () => {
        if (picture) {
            return (
                <View style={{ marginTop: 20 }}>
                    <Text>Picture Captured!</Text>
                    <Image
                        style={{ width: 200, height: 200, borderRadius: 15 }}
                        source={{ uri: `data:image/jpg;base64,${picture}` }}  // Display the captured picture
                    />
                </View>
            );
        }
        return null;
    };

    return (
        <SafeAreaView style={{ flex: 1, justifyContent: 'center', alignItems: 'center' }}>
            <TouchableOpacity
                style={{ padding: 20, backgroundColor: '#00AFA1', borderRadius: 8 }}
                onPress={handleTakePicture}
            >
                <Ionicons name="camera-outline" size={24} color="#fff" />
                <Text style={{ color: '#fff' }}>Take Picture</Text>
            </TouchableOpacity>

            {/* Camera view */}
            {showCamera && (
                <View style={{ flex: 1, width: '100%', height: '100%' }}>
                    <Camera
                        style={{ flex: 1 }}
                        type={Camera.Constants.Type.back}  // Use the back camera
                        ref={cameraRef}  // Attach ref to the camera
                    >
                        <TouchableOpacity
                            style={{
                                position: 'absolute',
                                bottom: 30,
                                left: '50%',
                                transform: [{ translateX: -50% }],
                                padding: 20,
                                backgroundColor: 'rgba(0, 0, 0, 0.5)',
                                borderRadius: 50,
                            }}
                            onPress={handleCapture}
                        >
                            <Ionicons name="camera" size={40} color="#fff" />
                        </TouchableOpacity>
                    </Camera>
                </View>
            )}

            {/* Render the captured picture if available */}
            {renderPicture()}
        </SafeAreaView>
    );
}
